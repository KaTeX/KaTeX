ss_steps: &ss_steps
  steps:
    - attach_workspace:
        at: .

    - restore_cache:
        keys:
          - npm-deps-v2-{{ checksum "package.json" }}
          - npm-deps-v2-
    - run:
        name: Install npm dependencies
        command: npm install

    - run:
        name: Verify screenshots and generate diff
        command: node dockers/Screenshotter/screenshotter.js --seleniumIP localhost -b $CIRCLE_JOB --verify --diff
    - run:
        name: Generate new screenshots
        when: always
        command: |
            rm -rf test/screenshotter/images/*
            node dockers/Screenshotter/screenshotter.js --seleniumIP localhost -b $CIRCLE_JOB

    - store_artifacts:
        path: test/screenshotter/images
        destination: image
    - store_artifacts:
        path: test/screenshotter/diff
        destination: diff

version: 2
jobs:
  test:
    docker:
      - image: circleci/node:6
    steps:
      - checkout
      - run:
          name: Checkout submodule
          command: |
              git submodule sync
              git submodule update --init --recursive

      - restore_cache:
          keys:
            - npm-deps-v0-{{ checksum "package.json" }}
            - npm-deps-v0-
      - run:
          name: Install npm dependencies
          command: npm install
      - save_cache:
          key: npm-deps-v0-{{ checksum "package.json" }}
          paths:
            - node_modules

      - run:
          name: Run tests
          command: npm test
      - run:
          name: Build KaTeX
          command: npm build

      - store_artifacts:
          path: build/katex.js
      - store_artifacts:
          path: build/katex.css
      - store_artifacts:
          path: build/fonts

      - persist_to_workspace:
          root: .
          paths:
            - dockers/Screenshotter
            - src
            - submodules
            - test/screenshotter
            - .babelrc
            - katex.js
            - katex.webpack.js
            - package.json
            - package-lock.json
            - webpack.common.js
            - webpack.dev.js

  firefox:
    docker:
      - image: circleci/node:6
      - image: selenium/standalone-firefox:2.48.2
    <<: *ss_steps
  chrome:
    docker:
      - image: circleci/node:6
      - image: selenium/standalone-chrome:2.48.2
    <<: *ss_steps

workflows:
  version: 2
  screenshotter:
    jobs:
      - test
      - firefox:
          requires:
            - test
      - chrome:
          requires:
            - test
